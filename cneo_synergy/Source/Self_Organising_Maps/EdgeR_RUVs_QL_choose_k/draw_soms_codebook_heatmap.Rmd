---
title: "R Notebook"
output: html_notebook
---


```{r}

if(!require(pacman)) {
  install.packages("pacman")
  library(pacman)
}

p_load(tidyverse)
p_load(gplots)
p_load(iheatmapr)


source( '../../Common/global_parameters.R')

```


```{r}

soms_results_dir <- file.path( results_dir, "Self_Organising_Maps/EdgeR_RUVs_QL/To_Use_k_0_Remove_5a/Condition_on_child_terms_true" ) 

compare_A_soms <- readRDS ( file.path( soms_results_dir, "compare_A/5x5/soms_results.RDS" ) )
compare_AL_soms <- readRDS ( file.path( soms_results_dir, "compare_AL/5x5/soms_results.RDS" ) )

## Read in the table showing direction of gene expression (for the genes in the cluster)
compare_A_direction <- read_tsv ( file.path( soms_results_dir,"compare_A/5x5/soms_clusters_mapping.txt"  )) %>%
                       mutate( Direction = case_when( str_detect(Direction, "Up")  ~ "Up",
                                                      str_detect(Direction, "Down")  ~ "Down",
                                                      TRUE ~ NA_character_
                                                      ) )        
  
compare_AL_direction <- read_tsv ( file.path( soms_results_dir,"compare_AL/5x5/soms_clusters_mapping.txt"  )) %>%
                       mutate( Direction = case_when( str_detect(Direction, "Up") ~ "Up",
                                                      str_detect(Direction, "Down") ~ "Down",
                                                      TRUE ~ NA_character_
                                                      ) )        

## Get a list of all the clusters which actually has data in them 
compare_A_cluster_with_data <- compare_A_direction %>%
                               mutate( cluster =  purrr::map_chr( cluster, ~paste( "V", ., sep="")) ) %>%
                               pull(cluster)

compare_AL_cluster_with_data <- compare_AL_direction %>%
                               mutate( cluster =  purrr::map_chr( cluster, ~paste( "V", ., sep="")) ) %>%
                               pull(cluster)


str(compare_A_soms$som$codes)

compare_A_codebook_vector_raw  <- compare_A_soms$som$codes[[1]]
compare_AL_codebook_vector_raw <- compare_AL_soms$som$codes[[1]]

compare_A_codebook_vector <- compare_A_codebook_vector_raw[compare_A_cluster_with_data,]
compare_AL_codebook_vector <- compare_AL_codebook_vector_raw[compare_AL_cluster_with_data,]
                 


```

## Check consistency of code book vector sample names order
```{r}
if ( any( colnames( compare_A_codebook_vector )  != colnames( compare_AL_codebook_vector )  ) ) {
  
  stop ( "Code book vector sample names order for AMB treatment and AMB + LF treatment are not consistent.")
}


```


```{r}
##################################################################################################################

# Heatmap of the codebook vector

my_colour_palette <- colorRampPalette(c("#2166ac","#f7f7f7","#b2182b"))(75) 
margins_size_factor <- 5
texts_size_factor_col <- 10
texts_size_factor_row <- 30
heatmap_column_labels <-  c( "CA1", "CA2", "CA3", "A1", "A2", "A3", "CAL1", "CAL2", "CAL3", "AL1",  "AL3" ) 

### AMB only model, A - CA
pdf( file.path( soms_results_dir, "compare_A/5x5/edgeR_compare_A_som_codebook_vector.pdf") ) 

heatmap.2(compare_A_codebook_vector[,heatmap_column_labels],  symm = FALSE, col = my_colour_palette, Colv=NA,  #distfun = function(c) as.dist(1 - c),
          dendrogram = "row", hclustfun=function(h)hclust(h,method="average"),  density.info="none", trace="none", # main = "Clustering miRNA with low to medium CV",
          #labRow=,
          xlab="Samples",
          ylab="Clusters",
          labCol= heatmap_column_labels, 
          cexCol= 0.0 + 1/log(length(compare_A_codebook_vector[1,]), texts_size_factor_col), cexRow= 0.0 + 1/log(length(compare_A_codebook_vector[,1]), texts_size_factor_row),
          margins = c(margins_size_factor, margins_size_factor),
          offsetRow = 0.02,
          offsetCol = 0.02 )
dev.off()


### AMB + LF model, AL - CAL
pdf( file.path( soms_results_dir, "compare_AL/5x5/edgeR_compare_AL_som_codebook_vector.pdf") ) 
          
heatmap.2(compare_AL_codebook_vector[,heatmap_column_labels],  symm = FALSE, col = my_colour_palette, Colv=NA,  #distfun = function(c) as.dist(1 - c),
          dendrogram = "row", hclustfun=function(h)hclust(h,method="average"),  density.info="none", trace="none", # main = "Clustering miRNA with low to medium CV",
          #labRow=, 
          xlab="Samples",
          ylab="Clusters",
          labCol= heatmap_column_labels, 
          cexCol= 0.0 + 1/log(length(compare_AL_codebook_vector[1,]), texts_size_factor_col), cexRow= 0.0 + 1/log(length(compare_AL_codebook_vector[,1]), texts_size_factor_row),
          margins = c(margins_size_factor, margins_size_factor),
          offsetRow = 0.02,
          offsetCol = 0.02 )
dev.off()
          


##################################################################################################################


```


```{r}

my_margins <- list(
  l = 5,
  r = 5,
  b = 10,
  t = 5,
  pad = 1
)

my_font <- list(
  family = "sans serif",
  size = 16,
  color = 'black')

my_vwidth <- 6
my_vheight <- 7

### AMB only model, A - CA
compare_A_iheatmapr <- main_heatmap( compare_A_codebook_vector[,heatmap_column_labels], 
                                     layout = list(margin = my_margins, font=my_font),
                                     name = "Standardized<br>Gene<br>Expression") %>%
  add_row_labels(size = 0.1) %>%
  add_col_labels() %>%
  add_row_clustering() %>%
  add_col_title("Clusters", buffer = 0.03) %>%
  add_row_title ("Samples",  buffer = 0.01) %>%
  add_row_annotation(  data.frame( Direction =  compare_A_direction$Direction) )

compare_A_iheatmapr

save_iheatmap( p=compare_A_iheatmapr, 
               filename = file.path( soms_results_dir, "compare_A/5x5/edgeR_compare_A_som_codebook_vector_iheatmapr.pdf"),
               vwidth = my_vwidth, vheight = my_vheight  )
save_iheatmap( p=compare_A_iheatmapr, 
               filename = file.path( soms_results_dir, "compare_A/5x5/edgeR_compare_A_som_codebook_vector_iheatmapr.png"),
               vwidth = my_vwidth, vheight = my_vheight  )


### AMB + LF model, AL - CAL
compare_AL_iheatmapr <- main_heatmap( compare_AL_codebook_vector[,heatmap_column_labels], 
                                     layout = list(margin = my_margins, font=my_font),
                                     name = "Standardized<br>Gene<br>Expression" )  %>%
  add_row_labels(size = 0.1) %>%
  add_col_labels() %>%
  add_row_clustering() %>%
  add_col_title("Clusters", buffer = 0.03) %>%
  add_row_title ("Samples",  buffer = 0.01) %>%
  add_row_annotation(  data.frame( Direction =  compare_AL_direction$Direction) )


compare_AL_iheatmapr

save_iheatmap( p=compare_AL_iheatmapr, 
               filename = file.path( soms_results_dir, "compare_AL/5x5/edgeR_compare_AL_som_codebook_vector_iheatmapr.pdf"),
               vwidth = my_vwidth, vheight = my_vheight     )
save_iheatmap( p=compare_AL_iheatmapr, 
               filename = file.path( soms_results_dir, "compare_AL/5x5/edgeR_compare_AL_som_codebook_vector_iheatmapr.png"),
               vwidth = my_vwidth, vheight = my_vheight)


```

