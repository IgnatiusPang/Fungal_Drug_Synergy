---
title: "R Notebook"
output: html_notebook
---



```{r}

if(!require(pacman)) {
  install.packages("pacman")
  library(pacman)
}

p_load(tidyverse)
p_load(plotly)
p_load(UpSetR)

source( '../Common/global_parameters.R')

```

## Read in input files
```{r}

de_genes_dir <- file.path( results_dir, "Differential_Expression/EdgeR_RUVs_QL/cneo/To_Use_k_0_Remove_5a/Gene_Lists")

compare_A_de_genes <- read_tsv( file.path(de_genes_dir, "compare_A.tab" )) 
compare_AL_de_genes <- read_tsv( file.path(de_genes_dir, "compare_AL.tab" ))

compare_A_de_genes_clean <- compare_A_de_genes %>%
                            dplyr::select( genes, logFC, FDR)

compare_AL_de_genes_clean <- compare_AL_de_genes %>%
                            dplyr::select( genes, logFC, FDR)

```


## Get gene annotation
```{r}
gene_annotation   <- read_tsv( file.path( data_dir, "Gene_Annotation/cneo_gene_annotation_summary.txt"  )  )


```


## Merge the AMB and AMB + LF treatments gene expressions fold-change table. 
```{r}
# dim( compare_A_de_genes)
# dim( compare_AL_de_genes)

compare_fold_change <- compare_A_de_genes_clean %>%
  inner_join( compare_AL_de_genes_clean, by = "genes", suffix = c( ".A", ".AL") ) %>%
  mutate( groups = case_when( FDR.A < 0.05 & FDR.AL < 0.05 & sign(logFC.A) != sign(logFC.AL) & logFC.A > 0  ~ "AMB up, AMB+LF down",
                              FDR.A < 0.05 & FDR.AL < 0.05 & sign(logFC.A) != sign(logFC.AL) & logFC.AL > 0  ~ "AMB down, AMB+LF up",
                              FDR.A < 0.05 & FDR.AL < 0.05 & sign(logFC.A) == sign(logFC.AL) & logFC.A > 0 ~ "Both up",
                              FDR.A < 0.05 & FDR.AL < 0.05 & sign(logFC.A) == sign(logFC.AL) & logFC.A < 0 ~ "Both down",
                              FDR.A < 0.05 & FDR.AL >= 0.05 & logFC.A > 0 ~ "AMB up only",
                              FDR.A < 0.05 & FDR.AL >= 0.05 & logFC.A < 0 ~ "AMB down only",
                              FDR.A >= 0.05 & FDR.AL < 0.05 & logFC.AL > 0 ~ "AMB+LF up only",
                              FDR.A >= 0.05 & FDR.AL < 0.05 & logFC.AL < 0 ~ "AMB+LF down only",
                              TRUE ~ "Not significant" )    ) %>%
  mutate( groups = factor (groups, levels=c( "AMB up, AMB+LF down", 
                                             "AMB down, AMB+LF up",
                                             "Both up",
                                             "Both down",
                                             "AMB up only",
                                             "AMB down only",
                                             "AMB+LF up only",
                                             "AMB+LF down only",
                                             "Not significant"
                                            ))) %>%
  mutate( coarse_groups = case_when( FDR.A < 0.05 & FDR.AL < 0.05 & sign(logFC.A) != sign(logFC.AL)  ~ "Opposite",
                              FDR.A < 0.05 & FDR.AL < 0.05 & sign(logFC.A) == sign(logFC.AL)  ~ "Same",
                              FDR.A < 0.05 & FDR.AL >= 0.05 ~ "AMB only",
                              FDR.A >= 0.05 & FDR.AL < 0.05 ~ "AMB+LF only",
                              TRUE ~ "Not significant" )    ) %>%
  mutate( coarse_groups = factor( coarse_groups, levels = c( "Same", "AMB only", "AMB+LF only", "Opposite", "Not significant")))

write.table( compare_fold_change, file = file.path( results_dir, "Compare_Fold_Change", "compare_A_AL_fold_change.tab" ), 
             sep="\t", row.names = FALSE, quote = FALSE ) 

```

```{r}
scatter_plot <-  compare_fold_change  %>%
                 ggplot(aes(logFC.A, logFC.AL, col=groups)) +
                 geom_point() +
                 xlab ( "AMB treatment log fold-change") +
                 ylab ( "AMB+LF treatment log fold-change") +
                 labs( col = "Is Statistically Significant")

scatter_plot

```

There were 3 genes that had opposite sig. log fold-change in AMB and AMB+LF treatment
CNAG_02691
CNAG_05638
CNAG_04363 up in AMB only, down in AMB+LF. 
All three genes were hypothetical only. Therefore we focused on genes that are significantly differentially expressed in AMB treatment or AMB+LF treatment only. 


```{r}
coarse_scatter_plot <-  compare_fold_change  %>%
                 ggplot(aes(logFC.A, logFC.AL, col=coarse_groups, text=genes)) +
                 geom_point() +
                 facet_grid ( . ~ coarse_groups) +
                 xlab ( "AMB treatment log fold-change") +
                 ylab ( "AMB+LF treatment log fold-change") +
                 labs( col = "Is Statistically Significant")

ggplotly( coarse_scatter_plot )

ggsave( plot=coarse_scatter_plot, filename= file.path( results_dir, "Compare_Fold_Change", "compare_A_AL_fold_change.pdf"))
ggsave( plot=coarse_scatter_plot, filename= file.path( results_dir, "Compare_Fold_Change", "compare_A_AL_fold_change.png"))
ggsave( plot=coarse_scatter_plot, filename= file.path( results_dir, "Compare_Fold_Change", "compare_A_AL_fold_change.svg"))
ggsave( plot=coarse_scatter_plot, filename= file.path( results_dir, "Compare_Fold_Change", "compare_A_AL_fold_change.tiff"))

```

```{r}

venn_diagram_data <- compare_fold_change %>%
  mutate( AMB_treatment = case_when( 
                                     FDR.A < 0.05 & logFC.A > 0 ~ 'AMB treatment, up',
                                     FDR.A < 0.05 & logFC.A < 0 ~ 'AMB treatment, down',
                                     TRUE ~ 'AMB treatment, n.s.'
                                     ),
          AMB_LF_treatment = case_when( 
                                     FDR.AL < 0.05 & logFC.AL > 0 ~ 'AMB+LF treatment, up',
                                     FDR.AL < 0.05 & logFC.AL < 0 ~ 'AMB+LF treatment, down',
                                     TRUE ~ 'AMB+LF treatment, n.s.'
                                     ) )  %>%
  mutate( AMB_treatment = factor(AMB_treatment, levels=c('AMB treatment, up',  'AMB treatment, n.s.', 'AMB treatment, down')),
          AMB_LF_treatment = factor(AMB_LF_treatment, levels=c('AMB+LF treatment, up',  'AMB+LF treatment, n.s.', 'AMB+LF treatment, down') )                     
                                 ) %>%
  dplyr::mutate( id = row_number() ) %>%
  dplyr::select( id, genes, AMB_treatment, AMB_LF_treatment)  


venn_diagram <- venn_diagram_data %>%
  group_by ( AMB_treatment, AMB_LF_treatment ) %>%
  count() %>%
  spread( AMB_LF_treatment, n)

venn_diagram
  

268+359
1392+1626+2+1
235+257


AMB_treatment_list <- venn_diagram_data %>%
  group_by (AMB_treatment ) %>%
  summarise( genes_list = list(id)) %>%
  pull(genes_list) %>%
  set_names(  levels(venn_diagram_data$AMB_treatment ) )


AMB_LF_treatment_list <- venn_diagram_data %>%
  group_by (AMB_LF_treatment ) %>%
  summarise( genes_list = list(id)) %>%
  pull(genes_list) %>%
  set_names(  levels(venn_diagram_data$AMB_LF_treatment ) )

upset_input <-  c(AMB_treatment_list, AMB_LF_treatment_list)

upset_input[[4]]

names(upset_input)
upset(fromList(upset_input), order.by = "freq", nsets = length( upset_input), keep.order=T,
          mainbar.y.label = "No. of Genes", sets.x.label = "No. of Genes", 
)


```



```{r}

compare_fold_change %>%
  group_by(groups) %>%
  count()

```



## Top 10 bottom 10 genes 
```{r}

all_genes_specific_to_AL <- compare_fold_change %>% 
  filter ( coarse_groups == "AMB+LF only") %>%
  arrange( desc(logFC.AL )) %>%
  mutate( rank_from_biggest_increase = row_number()) %>%
  arrange( logFC.AL ) %>%
  mutate( rank_from_biggest_decrease = row_number()) %>%
  left_join( gene_annotation, by=c("genes" = "orf_id")) %>%
  dplyr::select( -logFC.A, -FDR.A  )

write.table( all_genes_specific_to_AL, file.path( results_dir, "Compare_Fold_Change", "all_genes_specific_to_AL.tab"  ),
             row.names = FALSE, quote = FALSE, sep="\t") 


bottom_ten_log_fc_AL_specific <- compare_fold_change %>% 
  filter ( coarse_groups == "AMB+LF only") %>%
  arrange( logFC.AL ) %>%
  mutate( rank_from_biggest_decrease = row_number()) %>%
  left_join( gene_annotation, by=c("genes" = "orf_id")) %>%
  filter( rank_from_biggest_decrease <= 10 )


top_ten_log_fc_AL_specific <-  compare_fold_change %>% 
  filter ( coarse_groups == "AMB+LF only") %>%
  arrange( desc(logFC.AL )) %>%
  mutate( rank_from_biggest_increase = row_number()) %>%
  left_join( gene_annotation, by=c("genes" = "orf_id")) %>%
  filter( rank_from_biggest_increase <= 10 )


```


